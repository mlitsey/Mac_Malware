# The Art of Mac Malware

[Link to free online book](https://taomm.org/)

[Link to Objective-See tools](https://objective-see.org/index.html)

# Chapter 1

# Chapter 2 Persistance

## Launch Agents and Daemons

### 3rd party launch daemons and agents
```bash
# daemons
/Library/LaunchDaemons/
# agents
~/Library/LaunchAgents/
```

### parsing .plist files
```bash
plutil -p <path to plist>
defaults read <path to plist>
```

### macOS debugger  
`lldb <path to file>`

## Scheduled Jobs  

### Cron Jobs  
`/usr/bin/crontab`  

### At Jobs

```bash
# stored at
/private/var/at/jobs/
# enumerate
/usr/bin/atq
# scheduler
/usr/libexec/atrun
/usr/bin/at
# enable scheduler
launchctl load -w /System/Library/LaunchDaemons/com.apple.atrun.plist
```

### Periodic Scripts

```bash
# stored at
/etc/periodic/
```

## Login and Logout Hooks

```bash
# stored at user-specific
~/Library/Preferences/com.apple.loginwindow.plist
```

## Dynamic Libraries

# Chapter 4


## Microsoft Office Documents
`.docm` extension is a good indication that a file contains macros  

[oletools](https://github.com/decalage2/oletools/wiki/olevba) tool-set can be used for analysis  

```bash
sudo pip3 install -U oletools 
olevba -c <path/to/document>
```

## Applications

`CTRL-clicking` an application’s icon and selecting `Show Package Contents`  

free [Apparency](https://www.mothersruin.com/software/Apparency/use.html) application can also be used  

Apparency doesn’t show every file inside the app bundle so use in conjunction with `find`  

```zsh
find Final_Presentation.app/

Final_Presentation.app/
Final_Presentation.app/Contents Final_Presentation.app/Contents/_CodeSignature Final_Presentation.app/Contents/_CodeSignature/CodeResources
Final_Presentation.app/Contents/MacOS
Final_Presentation.app/Contents/MacOS/usrnode
Final_Presentation.app/Contents/Resources
Final_Presentation.app/Contents/Resources/en.lproj
Final_Presentation.app/Contents/Resources/en.lproj/MainMenu.nib
Final_Presentation.app/Contents/Resources/en.lproj/InfoPlist.strings
Final_Presentation.app/Contents/Resources/en.lproj/Credits.rtf
Final_Presentation.app/Contents/Resources/PPT3.icns
Final_Presentation.app/Contents/Info.plist
```

Read a binary `.plist` file use `defaults read`  
example: `defaults read app/path/Contents/Info.plist`  


# Chapter 5 Binary Analysis

## Mach-O File Format

### Header 
The `otool` utility can be used to parse Mach-O binaries.

```zsh
otool -hv Final_Presentation.app/Contents/MacOS/usrnode
Mach header
   magic         cputype     cpusubtype      filetype
MH_MAGIC_64       X86_64         ALL          EXECUTE
```

GUI interface [MachOView](https://sourceforge.net/projects/machoview/)  

Universal binaries use a `fat` header and need to be opened with `otool -f`

```zsh
file GoSearch22.app/Contents/MacOS/GoSearch22 GoSearch22: Mach-O universal binary with 2 architectures:
 [x86_64:Mach-O 64-bit executable x86_64] [arm64:Mach-O 64-bit executable arm64]

otool -fv GoSearch22.app/Contents/MacOS/GoSearch22 Fat headers
fat_magic FAT_MAGIC
nfat_arch 2
                 architecture x86_64
                     cputype CPU_TYPE_X86_64
                     cpusubtype CPU_SUBTYPE_X86_64_ALL
                     offset 4096
                     size 414368
                     ...
                 architecture arm64
                     cputype CPU_TYPE_ARM64
                     cpusubtype CPU_SUBTYPE_ARM64_ALL
                     offset 425984
                     size 521632
                     ...
```

Extract an architecture-specific Mach-O binary from a universal binary, use macOS’s `lipo` tool.  

```zsh
lipo GoSearch22.app/Contents/MacOS/GOSearch22 -thin x86_64 -output GoSearch22_INTEL 

file GoSearch22_INTEL
GoSearch22_INTEL:  Mach-O 64-bit executable x86_64
```

### Load Commands

You can view a Mach-O binary’s load commands with `otool` using the `-l` flag  
```zsh
otool -lv Final_Presentation.app/Contents/MacOS/usrnode 
...
Load command 1
                       cmd LC_SEGMENT_64
                   cmdsize 952
                   segname __TEXT
                    vmaddr 0x0000000100000000
                    vmsize 0x0000000000013000
                   fileoff 0
                  filesize 77824
                   maxprot rwx
                  initprot r-x
                    nsects 11
                     flags (none)
...
```

Load commands all begin with a `load_command` structure, defined in `mach-o/loader.h`.  

* LC_SEGMENT_64
* LC_SEGMENT
* LC_MAIN
* LC_LOAD_DYLIB
* 