# Apple Silicon Virtual Machine Parallels

# Problem
Can't configure macOS vm the way it was done on intel based hardware. 
* no snapshots
* no gui config
* default VM size is 67GB

# Solution

## Download macOS image and create the VM

Go [here](https://support.apple.com/en-us/102662) and download the image of the macOS version you want to use.  

Using [this](https://kb.parallels.com/en/125561) article create a new VM that is 20GB - 30GB or whatever size you need.  

1. Create the VM with no hard drive, from the terminal.  
`prlctl create "macOS_name" -o macos --no-hdd --restore-image <path to the .ipsw file>`  
example: `prlctl create "macOS14.3_test" -o macos --no-hdd --restore-image /Users/<username>/Downloads/UniversalMac_14.3.1_23D60_Restore.ipsw`  
2. Add the hard drive with desired size.  
`prlctl set "macOS14.3_test" --device-add hdd --type plain --size 20000`  
This will create a 20GB VM. My original test VM was just over 15GB.  
Once this is set it can't be changed.   
3. Start the VM.  
`prlctl start macOS14.3_test`  
4. Complete the full installation.  

## Configure the VM  

Using [this](https://kb.parallels.com/en/128842) article configure the VM from the terminal.  
`prlctl` only works on Pro+ versions. Edit the `config.pvs` in the VM bundle when using standard edition.  

1. Shutdown the VM and return to the terminal  
2. Configure memory  
`prlctl set <vm_name> --memsize <megabytes>`  
example `prlctl set "macOS14.3_test" --memsize 4096`  
3. Configure cpu  
`prlctl set <vm_name> --cpus <number>`
example `prlctl set "macOS14.3_test" --cpus 4`  
4. Change the MAC address  
`prlctl set "<vm_name>" --device-set <network_adapter_id> --mac <mac_address>`  
example `prlctl set "macOS14.3_test" --device-set net0 --mac 123456789ABC`  
5. Disable shared folders  
`prlctl set "<vm name>" --shf-host-defined off`  
example `prlctl set "macOS14.3_test" --shf-host-defined off`  

## Create VM clones

According to [this](https://kb.parallels.com/128867) article we can't create snapshots on macOS VM's currently.  
The next best solution is to create a clone of our newly created base VM and work from it.  
APFS is good at deduplicating the files and will use minimal disk space.  
[Video](https://youtu.be/Wf90ZRKF14s?si=-VQuCFEJY5vNNec5) of the process

1. Setup VM with everything you need.  
2. Shutdown the VM.  
3. Duplicate the VM by right-click -> Duplicate in the finder.  
4. Rename the file.  
5. Start the new VM by right-click -> open with -> Parallels  
6. Perform needed work.  
7. After finishing work delete the cloned VM and create another for the next project.  

